name: Build Aseprite Linux (Auto-Skia)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Aseprite
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y g++ cmake ninja-build libx11-dev libxcursor-dev libxi-dev libgl1-mesa-dev libfontconfig1-dev unzip

    - name: Download Skia (Automatic)
      run: |
        # 这一步是关键：自动读取源码中的配置，获取正确的下载链接
        # 避免因为版本不匹配导致报错
        skia_url=$(grep -oP 'https://github.com/aseprite/skia/releases/download/[^"]+' laf/misc/skia-url.sh | head -n 1)
        echo "Found Skia URL: $skia_url"
        
        # 下载并解压
        wget "$skia_url" -O skia.zip
        unzip skia.zip -d skia

    - name: Create Build Directory
      run: mkdir build

    - name: Configure CMake
      run: |
        cd build
        cmake \
          -DCMAKE_BUILD_TYPE=RelWithDebInfo \
          -DLAF_BACKEND=skia \
          -DSKIA_DIR=../skia \
          -DSKIA_LIBRARY_DIR=../skia/out/Release-x64 \
          -DSKIA_LIBRARY=../skia/out/Release-x64/libskia.a \
          -G Ninja \
          ..

    - name: Build Aseprite
      run: |
        cd build
